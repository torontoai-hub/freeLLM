worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    upstream proxy_app {
        server 127.0.0.1:8080;
    }

    upstream vllm_backend {
        # replace with your vLLM server
        server 10.0.0.2:8000;
    }

    map $upstream_http_x_proxy_backend $target_backend {
        default proxy_app;
        vllm vllm_backend;
        ollama proxy_app;
    }

    server {
        listen       80;
        server_name  _;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        location = /internal/authz {
            internal;
            proxy_pass http://proxy_app/internal/authz;
            proxy_pass_request_body on;
            proxy_set_header Content-Length $content_length;
            proxy_set_header Content-Type $content_type;
            proxy_set_header Authorization $http_authorization;
        }

        location ~ ^/v1/(chat/completions|completions|embeddings)$ {
            proxy_request_buffering off;

            auth_request /internal/authz;
            auth_request_set $auth_backend $upstream_http_x_proxy_backend;
            auth_request_set $rate_limit_checked $upstream_http_x_rate_limit_checked;
            auth_request_set $rl_limit_minute $upstream_http_x_rate_limit_limit_minute;
            auth_request_set $rl_remaining_minute $upstream_http_x_rate_limit_remaining_minute;
            auth_request_set $rl_limit_day $upstream_http_x_rate_limit_limit_day;
            auth_request_set $rl_remaining_day $upstream_http_x_rate_limit_remaining_day;

            set $target_upstream $target_backend;

            proxy_set_header X-RateLimit-Checked $rate_limit_checked;
            proxy_set_header Authorization $http_authorization;

            add_header X-RateLimit-Limit-Minute $rl_limit_minute always;
            add_header X-RateLimit-Remaining-Minute $rl_remaining_minute always;
            add_header X-RateLimit-Limit-Day $rl_limit_day always;
            add_header X-RateLimit-Remaining-Day $rl_remaining_day always;

            proxy_pass http://$target_upstream$request_uri;
        }

        location /v1/models {
            proxy_pass http://proxy_app$request_uri;
            proxy_set_header Authorization $http_authorization;
        }

        location /healthz {
            proxy_pass http://proxy_app/healthz;
        }

        location / {
            proxy_pass http://proxy_app$request_uri;
        }
    }
}
